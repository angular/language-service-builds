{"version":3,"file":"locate_symbol.js","sourceRoot":"","sources":["../../../../modules/@angular/language-service/src/locate_symbol.ts"],"names":[],"mappings":"AAAA;;;;;;GAMG;OAEI,EAAC,cAAc,EAAC,MAAM,mBAAmB;OAEzC,EAAC,SAAS,EAAC,MAAM,qCAAqC;OACtD,EAA2C,UAAU,EAAc,MAAM,oDAAoD;OAG7H,EAAC,kBAAkB,EAAE,mBAAmB,EAAC,MAAM,eAAe;OAC9D,EAAC,WAAW,EAAC,MAAM,aAAa;OAChC,EAAC,eAAe,EAAC,MAAM,iBAAiB;OAExC,EAAC,MAAM,EAAE,UAAU,EAAE,MAAM,EAAC,MAAM,SAAS;AAOlD,6BAA6B,IAAkB;IAC7C,IAAM,gBAAgB,GAAG,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,KAAK,CAAC;IAClE,IAAM,IAAI,GAAG,IAAI,eAAe,CAAC,IAAI,CAAC,WAAW,EAAE,gBAAgB,CAAC,CAAC;IACrE,EAAE,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC;QACd,IAAI,QAAM,GAAW,SAAS,CAAC;QAC/B,IAAI,MAAI,GAAS,SAAS,CAAC;QAC3B,IAAM,sBAAoB,GAAG,UAAC,GAAQ,EAAE,OAAwB;YAAxB,uBAAwB,GAAxB,eAAwB;YAC9D,IAAM,SAAS,GAAG,aAAa,CAAC,IAAI,CAAC,CAAC;YACtC,EAAE,CAAC,CAAC,SAAS,CAAC,CAAC,CAAC;gBACd,EAAE,CAAC,CAAC,MAAM,CAAC,gBAAgB,EAAE,MAAM,CAAC,SAAS,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC,CAAC;oBAC1D,IAAM,KAAK,GAAG,kBAAkB,CAAC,IAAI,EAAE,IAAI,EAAE,OAAO,CAAC,CAAC;oBACtD,IAAM,gBAAgB,GAAG,SAAS,CAAC,SAAS,CAAC,KAAK,CAAC,MAAM,GAAG,CAAC,CAAC;oBAC9D,IAAM,MAAM,GAAG,mBAAmB,CAC9B,KAAK,EAAE,GAAG,EAAE,gBAAgB,GAAG,gBAAgB,EAAE,IAAI,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC;oBAC1E,EAAE,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC;wBACX,QAAM,GAAG,MAAM,CAAC,MAAM,CAAC;wBACvB,MAAI,GAAG,UAAU,CAAC,MAAM,CAAC,IAAI,EAAE,gBAAgB,CAAC,CAAC;oBACnD,CAAC;oBACD,MAAM,CAAC,IAAI,CAAC;gBACd,CAAC;YACH,CAAC;YACD,MAAM,CAAC,KAAK,CAAC;QACf,CAAC,CAAC;QACF,IAAI,CAAC,IAAI,CAAC,KAAK,CACX;YACE,cAAc,YAAC,GAAG,IAAG,CAAC;YACtB,qBAAqB,YAAC,GAAG,IAAG,CAAC;YAC7B,YAAY,YAAC,GAAG;gBACd,IAAM,SAAS,GAAG,GAAG,CAAC,UAAU,CAAC,IAAI,CAAC,UAAA,CAAC,IAAI,OAAA,CAAC,CAAC,SAAS,CAAC,WAAW,EAAvB,CAAuB,CAAC,CAAC;gBACpE,EAAE,CAAC,CAAC,SAAS,CAAC,CAAC,CAAC;oBACd,QAAM,GAAG,IAAI,CAAC,QAAQ,CAAC,KAAK,CAAC,aAAa,CAAC,SAAS,CAAC,SAAS,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;oBAC/E,QAAM,GAAG,QAAM,IAAI,IAAI,kBAAkB,CAAC,QAAM,EAAE,WAAW,CAAC,CAAC;oBAC/D,MAAI,GAAG,MAAM,CAAC,GAAG,CAAC,CAAC;gBACrB,CAAC;gBAAC,IAAI,CAAC,CAAC;oBACN,iDAAiD;oBACjD,IAAM,SAAS,GACX,GAAG,CAAC,UAAU,CAAC,IAAI,CAAC,UAAA,CAAC,IAAI,OAAA,CAAC,CAAC,SAAS,CAAC,QAAQ,CAAC,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,IAAI,CAAC,EAA3C,CAA2C,CAAC,CAAC;oBAC1E,EAAE,CAAC,CAAC,SAAS,CAAC,CAAC,CAAC;wBACd,QAAM,GAAG,IAAI,CAAC,QAAQ,CAAC,KAAK,CAAC,aAAa,CAAC,SAAS,CAAC,SAAS,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;wBAC/E,QAAM,GAAG,QAAM,IAAI,IAAI,kBAAkB,CAAC,QAAM,EAAE,WAAW,CAAC,CAAC;wBAC/D,MAAI,GAAG,MAAM,CAAC,GAAG,CAAC,CAAC;oBACrB,CAAC;gBACH,CAAC;YACH,CAAC;YACD,cAAc,YAAC,GAAG;gBAChB,QAAM,GAAG,IAAI,CAAC,QAAQ,CAAC,KAAK,CAAC,aAAa,CAAC,cAAc,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC,CAAC;gBACtE,MAAI,GAAG,MAAM,CAAC,GAAG,CAAC,CAAC;YACrB,CAAC;YACD,aAAa,YAAC,GAAG,IAAG,CAAC;YACrB,UAAU,YAAC,GAAG;gBACZ,EAAE,CAAC,CAAC,CAAC,sBAAoB,CAAC,GAAG,CAAC,OAAO,EAAE,aAAa,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;oBAC3D,QAAM,GAAG,iBAAiB,CAAC,IAAI,EAAE,IAAI,EAAE,GAAG,CAAC,CAAC;oBAC5C,QAAM,GAAG,QAAM,IAAI,IAAI,kBAAkB,CAAC,QAAM,EAAE,OAAO,CAAC,CAAC;oBAC3D,MAAI,GAAG,MAAM,CAAC,GAAG,CAAC,CAAC;gBACrB,CAAC;YACH,CAAC;YACD,oBAAoB,YAAC,GAAG,IAAI,sBAAoB,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC;YAC9D,SAAS,YAAC,GAAG,IAAG,CAAC;YACjB,cAAc,YAAC,GAAG;gBAChB,IAAM,kBAAkB,GAAG,gBAAgB,GAAG,GAAG,CAAC,UAAU,CAAC,KAAK,CAAC,MAAM,CAAC;gBAC1E,EAAE,CAAC,CAAC,MAAM,CAAC,kBAAkB,EAAE,GAAG,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;oBAC/C,IAAM,KAAK,GAAG,kBAAkB,CAAC,IAAI,EAAE,IAAI,EAAE,kBAAkB,CAAC,KAAK,CAAC,CAAC;oBACvE,IAAM,MAAM,GACR,mBAAmB,CAAC,KAAK,EAAE,GAAG,CAAC,KAAK,EAAE,kBAAkB,EAAE,IAAI,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC;oBACnF,EAAE,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC;wBACX,QAAM,GAAG,MAAM,CAAC,MAAM,CAAC;wBACvB,MAAI,GAAG,UAAU,CAAC,MAAM,CAAC,IAAI,EAAE,GAAG,CAAC,UAAU,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC;oBAC9D,CAAC;gBACH,CAAC;YACH,CAAC;YACD,SAAS,YAAC,GAAG,IAAG,CAAC;YACjB,cAAc,YAAC,GAAG;gBAChB,QAAM,GAAG,IAAI,CAAC,QAAQ,CAAC,KAAK,CAAC,aAAa,CAAC,GAAG,CAAC,SAAS,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;gBACzE,MAAI,GAAG,MAAM,CAAC,GAAG,CAAC,CAAC;YACrB,CAAC;YACD,sBAAsB,YAAC,GAAG;gBACxB,EAAE,CAAC,CAAC,CAAC,sBAAoB,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC;oBACrC,QAAM,GAAG,gBAAgB,CAAC,IAAI,EAAE,IAAI,EAAE,GAAG,CAAC,CAAC;oBAC3C,MAAI,GAAG,MAAM,CAAC,GAAG,CAAC,CAAC;gBACrB,CAAC;YACH,CAAC;SACF,EACD,IAAI,CAAC,CAAC;QACV,EAAE,CAAC,CAAC,QAAM,IAAI,MAAI,CAAC,CAAC,CAAC;YACnB,MAAM,CAAC,EAAC,gBAAM,EAAE,IAAI,EAAE,UAAU,CAAC,MAAI,EAAE,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,KAAK,CAAC,EAAC,CAAC;QACpE,CAAC;IACH,CAAC;AACH,CAAC;AAED,uBAAuB,IAAkB;IACvC,IAAM,gBAAgB,GAAG,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,KAAK,CAAC;IAClE,IAAM,IAAI,GAAG,IAAI,WAAW,CAAC,IAAI,CAAC,OAAO,EAAE,gBAAgB,CAAC,CAAC;IAC7D,MAAM,CAAC,IAAI,CAAC,KAAK,CAAC,SAAS,CAAC,CAAC;AAC/B,CAAC;AAED,0BACI,IAAkB,EAAE,IAAqB,EAAE,OAAkC;IAC/E,IAAM,OAAO,GAAG,IAAI,CAAC,KAAK,CAAC,UAAU,CAAC,CAAC;IACvC,EAAE,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC;QACZ,GAAG,CAAC,CAAoB,UAAkB,EAAlB,KAAA,OAAO,CAAC,UAAU,EAAlB,cAAkB,EAAlB,IAAkB,CAAC;YAAtC,IAAM,SAAS,SAAA;YAClB,IAAM,aAAa,GAAG,SAAS,CAAC,SAAS,CAAC,SAAS,CAAC,MAAM,CAAC,CAAC;YAC5D,IAAM,SAAS,GAAG,aAAa,CAAC,OAAO,CAAC,YAAY,CAAC,CAAC;YACtD,EAAE,CAAC,CAAC,SAAS,CAAC,CAAC,CAAC;gBACd,IAAM,WAAW,GAAG,IAAI,CAAC,QAAQ,CAAC,KAAK,CAAC,aAAa,CAAC,SAAS,CAAC,SAAS,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;gBAC1F,EAAE,CAAC,CAAC,WAAW,CAAC,CAAC,CAAC;oBAChB,MAAM,CAAC,WAAW,CAAC,OAAO,EAAE,CAAC,GAAG,CAAC,SAAS,CAAC,CAAC;gBAC9C,CAAC;YACH,CAAC;SACF;IACH,CAAC;AACH,CAAC;AAED,2BACI,IAAkB,EAAE,IAAqB,EAAE,OAAsB;IACnE,IAAM,OAAO,GAAG,IAAI,CAAC,KAAK,CAAC,UAAU,CAAC,CAAC;IACvC,EAAE,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC;QACZ,GAAG,CAAC,CAAoB,UAAkB,EAAlB,KAAA,OAAO,CAAC,UAAU,EAAlB,cAAkB,EAAlB,IAAkB,CAAC;YAAtC,IAAM,SAAS,SAAA;YAClB,IAAM,eAAe,GAAG,SAAS,CAAC,SAAS,CAAC,SAAS,CAAC,OAAO,CAAC,CAAC;YAC/D,IAAM,SAAS,GAAG,eAAe,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC;YAChD,EAAE,CAAC,CAAC,SAAS,CAAC,CAAC,CAAC;gBACd,IAAM,WAAW,GAAG,IAAI,CAAC,QAAQ,CAAC,KAAK,CAAC,aAAa,CAAC,SAAS,CAAC,SAAS,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;gBAC1F,EAAE,CAAC,CAAC,WAAW,CAAC,CAAC,CAAC;oBAChB,MAAM,CAAC,WAAW,CAAC,OAAO,EAAE,CAAC,GAAG,CAAC,SAAS,CAAC,CAAC;gBAC9C,CAAC;YACH,CAAC;SACF;IACH,CAAC;AACH,CAAC;AAED,mBAAmB,GAA6B;IAC9C,IAAM,MAAM,GAA6B,EAAE,CAAC;IAC5C,GAAG,CAAC,CAAe,UAAgB,EAAhB,KAAA,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,EAAhB,cAAgB,EAAhB,IAAgB,CAAC;QAA/B,IAAM,MAAI,SAAA;QACb,IAAM,CAAC,GAAG,GAAG,CAAC,MAAI,CAAC,CAAC;QACpB,MAAM,CAAC,CAAC,CAAC,GAAG,MAAI,CAAC;KAClB;IACD,MAAM,CAAC,MAAM,CAAC;AAChB,CAAC;AAED;;GAEG;AACH;IACE,4BAAoB,GAAW,EAAU,YAAoB;QAAzC,QAAG,GAAH,GAAG,CAAQ;QAAU,iBAAY,GAAZ,YAAY,CAAQ;IAAG,CAAC;IAEjE,sBAAI,oCAAI;aAAR,cAAqB,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC,CAAC;;;OAAA;IAE5C,sBAAI,oCAAI;aAAR,cAAqB,MAAM,CAAC,IAAI,CAAC,YAAY,CAAC,CAAC,CAAC;;;OAAA;IAEhD,sBAAI,wCAAQ;aAAZ,cAAyB,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC,CAAC;;;OAAA;IAEpD,sBAAI,oCAAI;aAAR,cAA+B,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC,CAAC;;;OAAA;IAEtD,sBAAI,yCAAS;aAAb,cAAoC,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,SAAS,CAAC,CAAC,CAAC;;;OAAA;IAEhE,sBAAI,sCAAM;aAAV,cAAwB,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC,CAAC;;;OAAA;IAEjD,sBAAI,wCAAQ;aAAZ,cAA0B,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC,CAAC;;;OAAA;IAErD,sBAAI,0CAAU;aAAd,cAA+B,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,UAAU,CAAC,CAAC,CAAC;;;OAAA;IAE5D,oCAAO,GAAP,cAAY,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,OAAO,EAAE,CAAC,CAAC,CAAC;IAExC,uCAAU,GAAV,cAAe,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,UAAU,EAAE,CAAC,CAAC,CAAC;IAE9C,4CAAe,GAAf,UAAgB,KAAe,IAAI,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,eAAe,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC;IAE5E,oCAAO,GAAP,UAAQ,QAAgB,IAAI,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,OAAO,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC;IAClE,yBAAC;AAAD,CAAC,AA1BD,IA0BC","sourcesContent":["/**\n * @license\n * Copyright Google Inc. All Rights Reserved.\n *\n * Use of this source code is governed by an MIT-style license that can be\n * found in the LICENSE file at https://angular.io/license\n */\n\nimport {tokenReference} from '@angular/compiler';\nimport {AST} from '@angular/compiler/src/expression_parser/ast';\nimport {Attribute} from '@angular/compiler/src/ml_parser/ast';\nimport {BoundDirectivePropertyAst, BoundEventAst, ElementAst, TemplateAst} from '@angular/compiler/src/template_parser/template_ast';\n\nimport {TemplateInfo} from './common';\nimport {getExpressionScope, getExpressionSymbol} from './expressions';\nimport {HtmlAstPath} from './html_path';\nimport {TemplateAstPath} from './template_path';\nimport {Definition, Location, Span, Symbol, SymbolTable} from './types';\nimport {inSpan, offsetSpan, spanOf} from './utils';\n\nexport interface SymbolInfo {\n  symbol: Symbol;\n  span: Span;\n}\n\nexport function locateSymbol(info: TemplateInfo): SymbolInfo {\n  const templatePosition = info.position - info.template.span.start;\n  const path = new TemplateAstPath(info.templateAst, templatePosition);\n  if (path.tail) {\n    let symbol: Symbol = undefined;\n    let span: Span = undefined;\n    const attributeValueSymbol = (ast: AST, inEvent: boolean = false): boolean => {\n      const attribute = findAttribute(info);\n      if (attribute) {\n        if (inSpan(templatePosition, spanOf(attribute.valueSpan))) {\n          const scope = getExpressionScope(info, path, inEvent);\n          const expressionOffset = attribute.valueSpan.start.offset + 1;\n          const result = getExpressionSymbol(\n              scope, ast, templatePosition - expressionOffset, info.template.query);\n          if (result) {\n            symbol = result.symbol;\n            span = offsetSpan(result.span, expressionOffset);\n          }\n          return true;\n        }\n      }\n      return false;\n    };\n    path.tail.visit(\n        {\n          visitNgContent(ast) {},\n          visitEmbeddedTemplate(ast) {},\n          visitElement(ast) {\n            const component = ast.directives.find(d => d.directive.isComponent);\n            if (component) {\n              symbol = info.template.query.getTypeSymbol(component.directive.type.reference);\n              symbol = symbol && new OverrideKindSymbol(symbol, 'component');\n              span = spanOf(ast);\n            } else {\n              // Find a directive that matches the element name\n              const directive =\n                  ast.directives.find(d => d.directive.selector.indexOf(ast.name) >= 0);\n              if (directive) {\n                symbol = info.template.query.getTypeSymbol(directive.directive.type.reference);\n                symbol = symbol && new OverrideKindSymbol(symbol, 'directive');\n                span = spanOf(ast);\n              }\n            }\n          },\n          visitReference(ast) {\n            symbol = info.template.query.getTypeSymbol(tokenReference(ast.value));\n            span = spanOf(ast);\n          },\n          visitVariable(ast) {},\n          visitEvent(ast) {\n            if (!attributeValueSymbol(ast.handler, /* inEvent */ true)) {\n              symbol = findOutputBinding(info, path, ast);\n              symbol = symbol && new OverrideKindSymbol(symbol, 'event');\n              span = spanOf(ast);\n            }\n          },\n          visitElementProperty(ast) { attributeValueSymbol(ast.value); },\n          visitAttr(ast) {},\n          visitBoundText(ast) {\n            const expressionPosition = templatePosition - ast.sourceSpan.start.offset;\n            if (inSpan(expressionPosition, ast.value.span)) {\n              const scope = getExpressionScope(info, path, /* includeEvent */ false);\n              const result =\n                  getExpressionSymbol(scope, ast.value, expressionPosition, info.template.query);\n              if (result) {\n                symbol = result.symbol;\n                span = offsetSpan(result.span, ast.sourceSpan.start.offset);\n              }\n            }\n          },\n          visitText(ast) {},\n          visitDirective(ast) {\n            symbol = info.template.query.getTypeSymbol(ast.directive.type.reference);\n            span = spanOf(ast);\n          },\n          visitDirectiveProperty(ast) {\n            if (!attributeValueSymbol(ast.value)) {\n              symbol = findInputBinding(info, path, ast);\n              span = spanOf(ast);\n            }\n          }\n        },\n        null);\n    if (symbol && span) {\n      return {symbol, span: offsetSpan(span, info.template.span.start)};\n    }\n  }\n}\n\nfunction findAttribute(info: TemplateInfo): Attribute {\n  const templatePosition = info.position - info.template.span.start;\n  const path = new HtmlAstPath(info.htmlAst, templatePosition);\n  return path.first(Attribute);\n}\n\nfunction findInputBinding(\n    info: TemplateInfo, path: TemplateAstPath, binding: BoundDirectivePropertyAst): Symbol {\n  const element = path.first(ElementAst);\n  if (element) {\n    for (const directive of element.directives) {\n      const invertedInput = invertMap(directive.directive.inputs);\n      const fieldName = invertedInput[binding.templateName];\n      if (fieldName) {\n        const classSymbol = info.template.query.getTypeSymbol(directive.directive.type.reference);\n        if (classSymbol) {\n          return classSymbol.members().get(fieldName);\n        }\n      }\n    }\n  }\n}\n\nfunction findOutputBinding(\n    info: TemplateInfo, path: TemplateAstPath, binding: BoundEventAst): Symbol {\n  const element = path.first(ElementAst);\n  if (element) {\n    for (const directive of element.directives) {\n      const invertedOutputs = invertMap(directive.directive.outputs);\n      const fieldName = invertedOutputs[binding.name];\n      if (fieldName) {\n        const classSymbol = info.template.query.getTypeSymbol(directive.directive.type.reference);\n        if (classSymbol) {\n          return classSymbol.members().get(fieldName);\n        }\n      }\n    }\n  }\n}\n\nfunction invertMap(obj: {[name: string]: string}): {[name: string]: string} {\n  const result: {[name: string]: string} = {};\n  for (const name of Object.keys(obj)) {\n    const v = obj[name];\n    result[v] = name;\n  }\n  return result;\n}\n\n/**\n * Wrap a symbol and change its kind to component.\n */\nclass OverrideKindSymbol implements Symbol {\n  constructor(private sym: Symbol, private kindOverride: string) {}\n\n  get name(): string { return this.sym.name; }\n\n  get kind(): string { return this.kindOverride; }\n\n  get language(): string { return this.sym.language; }\n\n  get type(): Symbol|undefined { return this.sym.type; }\n\n  get container(): Symbol|undefined { return this.sym.container; }\n\n  get public(): boolean { return this.sym.public; }\n\n  get callable(): boolean { return this.sym.callable; }\n\n  get definition(): Definition { return this.sym.definition; }\n\n  members() { return this.sym.members(); }\n\n  signatures() { return this.sym.signatures(); }\n\n  selectSignature(types: Symbol[]) { return this.sym.selectSignature(types); }\n\n  indexed(argument: Symbol) { return this.sym.indexed(argument); }\n}\ninterface DecoratorInvocation {\n  type: Function;\n  args?: any[];\n}\n"]}